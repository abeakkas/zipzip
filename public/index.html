<html>
<head>
<style>
html, body {
  padding: 0px;
  margin: 0px;
}
</style>
<script src="touchtomouse.js"></script>
</head>
<body>
  <canvas id="canvas"></canvas>
  <center>
  <input type="text" placeholder="Nick" id="dom_nick"><br>
  <input type="submit" value="Start Game" onclick="startGame()" id="dom_start">
  </center>
<script>
singleTouchToMouse(canvas, true);

var HOST = location.origin.replace(/^http/, 'ws');

var messageLogging = false;

var ctx = canvas.getContext("2d");
var socket = null;

var game = {
  started: false,
  myId: 0,
  balls: [],
  players: []
};

var nicks = ["banjo", "reis", "kuki", "mustaa", "emes", "ertem", "patates", "lombak"];
dom_nick.value = nicks[Math.floor(Math.random() * nicks.length)];

initConnection(HOST);

function startGame() {
  var nick = dom_nick.value;
  if (nick == "") {
    alert("Nick cannot be empty!");
    return;
  }
  sendInit(nick);
  dom_start.style.display = "none";
  dom_nick.style.display = "none";
  ctx.strokeStyle = "red";
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
}

function initConnection(address) {
  socket = new WebSocket(address);
  socket.onmessage = function (event) {
    handleMessage(JSON.parse(event.data));
  }
}

function handleMessage(msg) {
  if (messageLogging && msg.type != "update") {
    console.log(msg);
  }
  switch (msg.type) {
    case "init":
      handleInit(msg);
      break;
    case "newplayer":
      handleNewPlayer(msg);
      break;
    case "removeplayer":
      handleRemovePlayer(msg);
      break;
    case "update":
      handleUpdate(msg);
      break;
  }
}

function handleInit(msg) {
  game.myId = msg.yourId;
  game.balls = msg.balls;
  game.players = msg.players;
}

function handleNewPlayer(msg) {
  game.players.push(msg.player);
}

function handleRemovePlayer(msg) {
  for (var i = 0; i < game.players.length; i++) {
    if (game.players[i].id == msg.playerId) {
      game.players.splice(i, 1);
      break;
    }
  }
}

function handleUpdate(msg) {
  game.balls = msg.balls;
  for (var i = 0; i < game.players.length; i++) {
    var player = game.players[i];
    var msgplayer = msg.players[player.id];
    if (msgplayer) {
      player.x = msgplayer.x;
      player.y = msgplayer.y;
    }
  }
  render();
}

function sendInit(nick) {
  socket.send(JSON.stringify({
    type: "init", name: nick
  }));
}

function sendAction(action) {
  socket.send(JSON.stringify({
    type: "action", action: action
  }));
}

function render() {
  if (canvas.width != window.innerWidth ||
    canvas.height != window.innerHeight) {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.translate(0, canvas.height);
  ctx.scale(1, -1);
  ctx.scale(canvas.width, canvas.width);

  for (var i = 0; i < game.players.length; i++) {
    var player = game.players[i];
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x - player.w / 2, player.y, player.w, player.h);
  }

  for (var i = 0; i < game.balls.length; i++) {
    var ball = game.balls[i];
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI);
    ctx.fillStyle = "gray";
    ctx.fill();
  }

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.strokeStyle = "black";
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
}

canvas.onmousedown = function (e) {
  var x = e.clientX - canvas.getBoundingClientRect().left;
  var y = e.clientX - canvas.getBoundingClientRect().right;
  if (x < canvas.width / 3) {
    sendAction("left");
  } else if (x < canvas.width * 2 / 3) {
    sendAction("jump");
  } else {
    sendAction("right");
  }
};

canvas.onmouseup = function (e) {
  sendAction("stop");
};
</script>
</body>
</html>

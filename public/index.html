<html>
<head>
<style>
html, body {
  padding: 0px;
  margin: 0px;
}
</style>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="touchtomouse.js"></script>
</head>
<body>
  <canvas id="canvas" style="z-index: 0; position: absolute; top: 0px; left: 0px;"></canvas>
  <div id="dom_initdiv" style="z-index: 100; margin-top: 100px; position: absolute; width: 100%; height: 100%;">
  <center>
  <input type="text" placeholder="Nick" id="dom_nick"><br>
  <input type="submit" value="Start Game" onclick="startGame()" id="dom_start">
  </center>
  </div>
<script>
singleTouchToMouse(canvas, true);

var HOST = location.origin.replace(/^http/, 'ws');

var messageLogging = false;

var ctx = canvas.getContext("2d");
var socket = null;

var game = {
  started: false,
  myId: 0,
  balls: [],
  players: []
};

var nicks = ["banjo", "reis", "kuki", "mustaa", "emes", "ertem", "patates", "lombak"];
dom_nick.value = nicks[Math.floor(Math.random() * nicks.length)];

initConnection(HOST);

function startGame() {
  var nick = dom_nick.value;
  if (nick == "") {
    alert("Nick cannot be empty!");
    return;
  }
  sendInit(nick);
  dom_initdiv.style.display = "none";
  ctx.strokeStyle = "red";
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
}

function initConnection(address) {
  socket = new WebSocket(address);
  socket.onmessage = function (event) {
    handleMessage(JSON.parse(event.data));
  }
}

function handleMessage(msg) {
  if (messageLogging && msg.type != "update") {
    console.log(msg);
  }
  switch (msg.type) {
    case "init":
      handleInit(msg);
      break;
    case "newplayer":
      handleNewPlayer(msg);
      break;
    case "removeplayer":
      handleRemovePlayer(msg);
      break;
    case "update":
      handleUpdate(msg);
      break;
  }
}

function handleInit(msg) {
  game.myId = msg.yourId;
  game.balls = msg.balls;
  game.players = msg.players;
}

function handleNewPlayer(msg) {
  game.players.push(msg.player);
}

function handleRemovePlayer(msg) {
  for (var i = 0; i < game.players.length; i++) {
    if (game.players[i].id == msg.playerId) {
      game.players.splice(i, 1);
      break;
    }
  }
}

function handleUpdate(msg) {
  game.balls = msg.balls;
  for (var i = 0; i < game.players.length; i++) {
    var player = game.players[i];
    var msgplayer = msg.players[player.id];
    if (msgplayer) {
      player.x = msgplayer.x;
      player.y = msgplayer.y;
    }
  }
  render();
}

function sendInit(nick) {
  socket.send(JSON.stringify({
    type: "init", name: nick
  }));
}

function sendAction(action) {
  socket.send(JSON.stringify({
    type: "action", action: action
  }));
}

function render() {
  if (canvas.width != window.innerWidth ||
    canvas.height != window.innerHeight) {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.translate(0, canvas.height);
  ctx.scale(1, -1);
  ctx.scale(canvas.width, canvas.width);

  for (var i = 0; i < game.players.length; i++) {
    var player = game.players[i];
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x - player.w / 2, player.y, player.w, player.h);
  }

  for (var i = 0; i < game.balls.length; i++) {
    var ball = game.balls[i];
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI);
    ctx.fillStyle = "gray";
    ctx.fill();
  }

  ctx.setTransform(1, 0, 0, 1, 0, 0);

  ctx.font="20px Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillStyle = "black";
  for (var i = 0; i < game.players.length; i++) {
    ctx.fillText(player.name, player.x * canvas.width, canvas.height - (player.y + player.h * 1.1) * canvas.width);
  }

  ctx.strokeStyle = "black";
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
}

var buttonState = {
  left: false,
  right: false,
  jump: false
};

canvas.ontouchstart = function (e) {
  var x = e.target.clientX - canvas.getBoundingClientRect().left;
  var y = e.target.clientX - canvas.getBoundingClientRect().right;
  if (x < canvas.width / 3) {
    sendAction("left");
    buttonState.left = e.target.identifier;
  } else if (x < canvas.width * 2 / 3) {
    sendAction("jump");
  } else {
    sendAction("right");
    buttonState.right = e.target.identifier;
  }
};

canvas.ontouchend = canvas.ontouchcancel = function (e) {
  if (e.target.identifier == buttonState.left) {
    sendAction("stop");
    buttonState.left = false;
  }
  if (e.target.identifier == buttonState.right) {
    sendAction("stop");
    buttonState.right = false;
  }
};

document.onkeydown = function (e) {
  if (e.keyCode == 37 && buttonState.left == false) {
    sendAction("left");
    buttonState.left = true;
  }
  if (e.keyCode == 38 && buttonState.jump == false) {
    sendAction("jump");
    buttonState.jump = true;
  }
  if (e.keyCode == 39 && buttonState.right == false) {
    sendAction("right");
    buttonState.right = true;
  }
}

document.onkeydown = function (e) {
  if (e.keyCode == 37 && buttonState.left == true) {
    sendAction("stop");
    buttonState.left = false;
  }
  if (e.keyCode == 38 && buttonState.jump == true) {
    buttonState.jump = false;
  }
  if (e.keyCode == 39 && buttonState.right == true) {
    sendAction("stop");
    buttonState.right = false;
  }
}
</script>
</body>
</html>
